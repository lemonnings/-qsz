# WarnRectUtil - 矩形AOE预警工具

## 功能描述

`WarnRectUtil` 是一个用于创建boss技能矩形范围AOE攻击预警的工具类。它基于圆形预警工具的逻辑，专门用于创建线性、激光束、光束等矩形区域的预警效果。

## 主要特性

### 视觉效果
- **渐变生成**: 预警时间前1/4，红色矩形从中心向外扩散至目标大小
- **稳定显示**: 中间时间保持稳定的红色透明矩形（透明度0.35）
- **加速闪烁**: 最后1/4时间开始闪烁，频率逐渐加快
- **渐变消失**: 最后0.1秒红色矩形渐变消失

### 形状特点
- **线性区域**: 从起始点到目标点形成矩形区域
- **可调宽度**: 通过宽度参数控制矩形的厚度
- **任意角度**: 支持任意方向的矩形AOE
- **精确碰撞**: 准确的矩形范围伤害检测

### 伤害系统
- 预警结束后自动检测玩家是否在矩形范围内
- 对范围内的玩家造成指定伤害
- 支持伤害回调和信号

## 使用方法

### 基本用法

```gdscript
# 创建预警矩形
var warning_rect = WarnRectUtil.new()
add_child(warning_rect)

# 连接信号
warning_rect.warning_finished.connect(_on_warning_finished)
warning_rect.damage_dealt.connect(_on_damage_dealt)

# 获取动画播放器
var laser_anim = get_node("LaserAnimationPlayer")

# 开始预警
warning_rect.start_warning(
    Vector2(200, 300),  # 起始位置
    Vector2(600, 300),  # 目标点
    80.0,               # 宽度
    2.5,                # 预警时间(秒)
    90.0,               # 伤害值
    laser_anim          # 动画播放器
)
```

### 对角线激光

```gdscript
# 创建对角线激光攻击
var diagonal_anim = get_node("DiagonalLaserAnimationPlayer")
warning_rect.start_warning(
    Vector2(100, 100),  # 起始位置
    Vector2(700, 500),  # 目标点（对角线）
    60.0,               # 激光宽度
    3.0,                # 预警时间
    120.0,              # 伤害值
    diagonal_anim       # 动画播放器
)
```

### 指向玩家的光束

```gdscript
# 从boss位置指向玩家的光束攻击
var player = get_tree().get_first_node_in_group("player")
var boss_pos = global_position
var player_pos = player.global_position
var beam_anim = get_node("BeamAnimationPlayer")

warning_rect.start_warning(
    boss_pos,           # 起始位置（boss）
    player_pos,         # 目标点（玩家）
    100.0,              # 光束宽度
    2.0,                # 预警时间
    150.0,              # 伤害值
    beam_anim           # 动画播放器
)
```

### 多重激光阵列

```gdscript
# 创建十字形激光阵列
var laser_patterns = [
    {"start": Vector2(100, 300), "end": Vector2(700, 300)},  # 水平
    {"start": Vector2(400, 100), "end": Vector2(400, 500)},  # 垂直
    {"start": Vector2(200, 200), "end": Vector2(600, 400)},  # 对角线1
    {"start": Vector2(600, 200), "end": Vector2(200, 400)}   # 对角线2
]

for i in range(laser_patterns.size()):
    var pattern = laser_patterns[i]
    var warning = WarnRectUtil.new()
    add_child(warning)
    
    # 延迟启动，创造连续效果
    await get_tree().create_timer(i * 0.3).timeout
    
    var cross_laser_anim = get_node("CrossLaserAnimationPlayer")
    warning.start_warning(
        pattern["start"],
        pattern["end"],
        50.0,               # 激光宽度
        1.8,                # 预警时间
        80.0,               # 伤害值
        cross_laser_anim
    )
```

## API 参考

### 方法

#### `start_warning(pos, target_point, width, warning_time, damage, animation_player)`
开始矩形AOE预警

**参数:**
- `pos: Vector2` - 起始位置
- `target_point: Vector2` - 目标点位置
- `width: float` - 矩形宽度
- `warning_time: float` - 预警持续时间(秒)
- `damage: float` - 造成的伤害值
- `animation_player: AnimationPlayer` - 预警结束后播放的动画播放器

#### `cleanup()`
清理资源，释放内存

### 信号

#### `warning_finished`
预警结束时发出

#### `damage_dealt(damage_amount)`
对玩家造成伤害时发出
- `damage_amount: float` - 实际造成的伤害值

### 属性

- `target_point: Vector2` - 当前目标点
- `width: float` - 当前矩形宽度
- `warning_time: float` - 当前预警时间
- `damage: float` - 当前伤害值
- `animation_player: AnimationPlayer` - 当前动画播放器
- `rect_length: float` - 矩形长度（自动计算）
- `rect_angle: float` - 矩形角度（自动计算）

## 实现细节

### 时间轴

1. **0% - 25%**: 从中心扩散到目标大小
2. **25% - 75%**: 稳定显示红色矩形
3. **75% - 90%**: 开始闪烁，频率逐渐加快
4. **90% - 100%**: 渐变消失

### 坐标计算

- **矩形中心**: 起始点和目标点的中点
- **矩形长度**: 起始点到目标点的距离
- **矩形角度**: 从起始点指向目标点的角度
- **碰撞检测**: 将玩家坐标转换到矩形本地坐标系进行检测

### 伤害检测

矩形碰撞检测通过以下步骤实现：
1. 计算玩家相对于矩形中心的位置
2. 将坐标旋转到矩形的本地坐标系
3. 检查旋转后的坐标是否在矩形范围内

### 依赖文件

- `rect_drawer.gd` - 负责绘制矩形形状
- 需要场景中存在名为"player"的组

## 适用场景

### 激光类技能
- 直线激光束
- 扫射激光
- 十字激光
- 对角线激光

### 冲锋类技能
- Boss冲锋攻击
- 直线冲撞
- 路径预警

### 范围技能
- 矩形火墙
- 线性爆炸
- 剑气斩击

## 注意事项

1. 确保玩家节点在"player"组中
2. 玩家节点需要有`take_damage(damage)`方法
3. 使用完毕后调用`cleanup()`释放资源
4. 需要提前准备好AnimationPlayer节点用于播放预警结束后的动画
5. 起始点和目标点不能相同，否则无法计算矩形方向

## 与圆形工具的区别

| 特性 | 圆形工具 | 矩形工具 |
|------|----------|----------|
| 形状 | 圆形/椭圆形 | 矩形 |
| 参数 | 半径 + 长宽比 | 起始点 + 目标点 + 宽度 |
| 适用场景 | 爆炸、范围魔法 | 激光、冲锋、线性攻击 |
| 碰撞检测 | 距离计算 | 坐标变换 |

## 示例场景

参考 `warn_rect_example.gd` 文件查看完整的使用示例，包括各种激光模式和攻击模式。


		# 基础，黄酒，米酒，花果酒，枸杞酒，羊羔酒，锦江春，琼浆100/200/300/450/600/800/1000gil，进货价初始为30%，米饭150gil，进货价初始为33%，
		# 小料：太岁冻30gil，果味灯油50gil，
		# 小吃，蛙肉串80gil
		# 每个人10岁都会觉醒一个天赋，坎塞尔拿到了一套厨具，开始他以为只是跟大部分人一样决定了他未来的职业
		# 但是直到后面得一次魔物入侵中，他用菜刀杀掉了一个魔物，发现菜刀不仅在一段时间内变得更锋利，而且魔物的一部分力量也被自身永久吸收了
		# 这个镇子是在边疆地带，经常有驻扎士兵和冒险者来这边，一边干掉魔物一边发展酒馆
		# 选择区域探索，每个区域有3个boss和1个隐藏Boss，
		# 每个boss击败后有概率收服，添加为酒馆服务员，3个boss都击败后，在狂暴模式下会出现隐藏boss

		# 外溢能量pp，在结束一局后可以转换为加点
		# t1 atk point+ hp max30(t2 40 t3 60 t4 100) total60->t2 
		# t2 atks spd cri% otherEquip
		# t3 exp% bulletSize criatk% max25 （t3 40 t4 60) total 60->t3
		# t4  atk% hp% point+ lky otherEquip max20(t4 40) total 60->t4
		# t5 finaldmg% def% otherEquip max20
		
		# 厨刀 可以飞射出去
		# 斩骨斧 近战武器
		# 釜 近战范围砸地
		# 匕 勺子，环绕
		# 笊篱 长柄漏勺 远程爆炸
		# 碾轮 直线范围
		# 漏勺 散射
		# 壶 类似树枝，分裂
		# 鼎 日炎
		# 每天可以选择作为经营日 狩猎日
		# 经营获得的gil可以强化厨具，提升厨具的基本atk%，解锁局内lv上限，从15->20->25
		# gil可以向旅行商人或者佣兵冒险者购买各种饰品和圣器，找镇里铁匠强化圣器，给服务员薪资礼物
		# 饰品只要获得就可以永久增加属性，圣器为战前启用初始2个，通过饰品解锁到最多同时5个		# hero最多4张，初始一张0，cd 30s 200以太，使用后需要等1分钟才能部署第3张，消耗400以太，cd 2分钟，第4张800以太
		# atk24.375-》48.75
		# 维德尼尔：攻击15 HP60 攻速0.8，skill1 攻击附带一枚羽毛，追踪一个单位造成30/38~70%%atk，skill2 消耗200以太，在12秒内，攻速+100%，并额外提升0/5~25%攻击
		# 被动 使用skill2后抽1张牌，skill2同时提升6%~30%暴击率
		# 5条进攻线路，初始有5排空间，商店解锁第6,7排，每个格子有6点容量
		# 右侧专有的能源区可以放向日葵，相当于一个容量18的格子，初始pp效率每秒+10
		# 向日葵，提升效率5+总体提升3%，消耗100pp，容量3
		# 豌豆射手，每次攻击消耗3以太，造成10伤害 攻速1，容量2，建造消耗150pp			# 各类型的牌基本实现
			# 向日葵
			# 豌豆射手
			# 菜问
			# 指挥官 200pp 一次性，提升周围2格范围内攻速20%，造成15伤害 攻速1，容量3
			# 基地建设 固有，0pp，获得1张向日葵
			# 振奋 50pp 给战斗单位添加4层振奋buff，每层提升10%攻击，每5秒损失1层
			# 整备预备 300pp 蓄能50：减少pp消耗 抽2张牌，每抽到1张单位牌回复50pp
			# 定点轰炸 150pp 随机选择地图上的1个目标，对其周围1格敌人造成15atk，重复10次
			# 卫护所 大型建筑，200pp，会对前一格每15秒产生一个容量2的卫护兵，攻击12 攻速1.2 hp50
			# 聚居地 大型建筑，100pp，对周围一格范围内的所有地块添加3点容量
			# 法师塔 大型建筑，150pp，atk25 aspd2 投射，范围全图 每次攻击消耗5pp
			# 高台 小型建筑，50pp，容量3，放置在该格的战斗单位变为投射并额外提升30%atk
			# 防御基底 大型建筑，50pp
			# 过载 50pp，提升100%pp获得，持续10秒，10秒后损失30%当前pp


		# 酒馆属性：知名度，每次狩猎后结算可以获得，每日经营也可以获得少量，可以解锁新的客人类型，并按比例提升菜单售价，每10点+1%
		# 客人：分几个类型，居民，纯消费，提供100%正常菜单额度，点1~2份饮品+1~2分餐食，佣兵会倾向于点2~3份饮品类+1份餐食类，冒险者会倾向于点餐食类，他们偶尔会讨论战斗技巧，提升对对应种类怪的伤害
		# 流动小贩会出售饰品，药剂师会提供强化药剂，铁匠可以帮忙以优惠的价格升级饰品或者厨具，大商人会额外给一份等值小费，贤者会给予一个只有在下次狩猎日有效的buff
		# 进货商可以减免一种商品的10%进货价

        
	# 羁绊设计：基于中国，北欧，希腊，埃及神话，每个神话有N个专属的主羁绊，然后有共通的若干个子羁绊
		# 例如，中国神话的主羁绊可以设计为九重天（道教的三清，四御...），佛土（佛陀，菩萨...），山海经（麒麟，穷奇...），
		# 麒麟：山海经3 祥瑞2 守护者1
		# 青龙&朱雀：九重天3 星辰使2 祥瑞1
		# 百解：祥瑞1 斗士1 凶兽1
	# 大羁绊固定派系下的*3=9个，对应领袖*1有3个，可以凑到12
	# 小羁绊英雄*2的有3个，加上1个*1的最多可以凑到7，携带6个领袖，*1的有5个，可以凑到12，专武有两个+1，铜银金各+1，彩+2，彩卡+1
	# 基准，战力类提升3：10%，6,24%，9:50%，12：:90%，15，150%，18，280%
	# 不死：HP降至1以下会无敌2秒，期间提升,80%的攻速，冷却60秒 3：持续时间+2s，冷却-20s
	# 6：期间额外提升80%攻击，并且在不死状态结束后恢复30%最大hp
	# 9：持续时间+2s，冷却-15s
	# 12：如果在冷却中hp再次降到0以下，会进入复燃状态，期间无法攻击，阻挡敌人，在不死的冷却完成后会复生并立刻触发不死
	# 15，期间提升攻击攻速提升至100%，持续时间+2s，冷却-10s
	# 18，期间提升攻击攻速提升至150%，持续时间+2s
	# 祥瑞：3：祥瑞秘宝的最大数量为6,
	# 6：每波次结束后获得1个秘宝，祥瑞秘宝最大数量提升至8，
	# 9：每波次结束后获得2个秘宝，祥瑞秘宝最大数量提升至10,
	# 12，每波次结束后获得3个秘宝，祥瑞秘宝数量最大提升至13,
	# 15，每波次结束后获得5个秘宝，祥瑞秘宝数量最大提升至16,
	# 18，每波次结束后获得8个秘宝，祥瑞秘宝数量最大提升至24
	# 秘宝价值：1个秘宝：2价值，2个秘宝，5价值，3:9,4：:14,5:20,6:28
	# 7:40,8:52
	# 9:68，10:84
	# 11:104，12:124,13:144
	# 14:168,15:192,16:216
	# 17:240 18:270 19:310 20:360 21:420 22:490 23:570 24:660
	# 奖励类型：25pp->1 蓝卡 5 紫卡 40 金卡 80 红卡 200 铜海克斯 25 银 75 金 140 虹 240 散件 20 成装 35 光明装 80 专武 140 秘宝特殊武器 100 秘宝特殊海克斯 200 
	# 雷电：3,攻击有25%触发一道雷光，随机攻击场上一个敌人造成40%atk
	# 6，触发概率提升至30%，攻击速度额外提升8%，雷光伤害对boss提升10%
	# 9，触发概率提升至35%，伤害提升至75%atk
	# 12，触发概率提升至40%，攻击速度提升量增至40%，雷光伤害对boss提升30%
	# 15，触发概率提升至50%，伤害提升至90%atk，攻击速度提升量增至60%
	# 18，伤害提升至125%atk，攻击速度提升量增至100%，雷光伤害对boss提升70%
	# 烈焰：
	# 凶兽：
	# 